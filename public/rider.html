<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Pasajero</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css">
    <style>
        #map { height: 250px; width: 100%; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; z-index: 1; }
        .autocomplete-container { position: relative; }
        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
            max-height: 200px; overflow-y: auto; z-index: 1000; display: none;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .suggestion-item:hover { background: #f0f9ff; color: var(--primary); }
        .timer-container { margin-top: 10px; background: #f1f5f9; border-radius: 4px; height: 6px; overflow: hidden; position: relative; }
        .timer-bar { height: 100%; background: #f59e0b; width: 100%; transition: width 1s linear; }
        .timer-label { font-size: 0.75rem; color: #64748b; display: flex; justify-content: space-between; margin-top: 2px; }
        .pulse-text { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <div>
                    <h2><i class="fa-solid fa-person-walking-luggage"></i> Pasajero</h2>
                    <small id="userDisplay">Cargando...</small>
                </div>
                <button onclick="logout()" class="logout-btn"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div style="padding: 0 15px; padding-bottom: 70px;">
            <div id="tab-request" class="tab-content">
                <div class="card" style="border-left-color: var(--primary);">
                    <h3 style="margin-top:0;"><i class="fa-solid fa-magnifying-glass-location"></i> Nuevo Viaje</h3>
                    <div id="map"></div>
                    <label>Origen</label>
                    <div class="input-group autocomplete-container">
                        <input type="text" id="origin" placeholder="Direcci√≥n..." oninput="searchAddress(this.value, 'origin')">
                        <div id="suggestions-origin" class="suggestions-list"></div>
                    </div>
                    <label>Destino</label>
                    <div class="input-group autocomplete-container">
                        <input type="text" id="dest" placeholder="Direcci√≥n..." oninput="searchAddress(this.value, 'dest')">
                        <div id="suggestions-dest" class="suggestions-list"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Oferta (S/.)</label><input type="number" id="amt" placeholder="0.00"></div>
                        <div>
                            <label>Pago</label>
                            <select id="method">
                                <option value="cash">üíµ Efectivo</option>
                                <option value="card">üí≥ Tarjeta</option>
                                <option value="yape">üì± Yape</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="requestTrip()" style="margin-top:15px; background:var(--dark);">Solicitar Taxi</button>
                    <button onclick="resetMap()" style="background:#e2e8f0; color:#333; margin-top:10px; font-size:0.85rem;"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                </div>
            </div>

            <div id="tab-status" class="tab-content hidden">
                <h3 style="margin-top:0;">‚è≥ Estado del Viaje</h3>
                <div id="active-list"></div>
            </div>

            <div id="tab-history" class="tab-content hidden">
                <h3 style="margin-top:0;">üìú Historial</h3>
                <div id="history-list"></div>
            </div>
        </div>

        <div class="nav-bar" style="position:absolute; bottom:0; left:0; right:0; margin:0; border-top:1px solid #ddd;">
            <button class="nav-item active" onclick="showTab('request', this)"><i class="fa-solid fa-map-location"></i> Solicitar</button>
            <button class="nav-item" onclick="showTab('status', this)"><i class="fa-solid fa-car"></i> Viajes</button>
            <button class="nav-item" onclick="showTab('history', this)"><i class="fa-solid fa-list"></i> Historial</button>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentUser, map, markerOrigin, markerDest, polyline, searchTimeout;
        const TIME_LIMIT = 60; 

        const paymentLabels = {
            'cash': '<i class="fa-solid fa-money-bill-wave"></i> Efectivo',
            'card': '<i class="fa-regular fa-credit-card"></i> Tarjeta',
            'yape': '<i class="fa-solid fa-mobile-screen"></i> Yape'
        };

        async function init() {
            currentUser = await protectRoute('rider');
            if(currentUser) {
                document.getElementById('userDisplay').innerText = `Hola, ${currentUser.name}`;
                startPolling();
                initMap();
            }
        }
        function getTimestampFromId(id) { return parseInt(id.substring(0, 8), 16) * 1000; }
        
        // --- MAPA ---
        function initMap() {
            map = L.map('map').setView([-12.0464, -77.0428], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', function(e) {
                if(!markerOrigin) setLocation('origin', e.latlng, "Ubicaci√≥n Manual");
                else if(!markerDest) setLocation('dest', e.latlng, "Ubicaci√≥n Manual");
            });
        }
        function searchAddress(q, type) { 
            clearTimeout(searchTimeout);
            const list = document.getElementById(`suggestions-${type}`);
            if(q.length < 3) return list.style.display = 'none';
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=pe&limit=3`);
                    const data = await res.json();
                    list.innerHTML = '';
                    if(data.length) {
                        list.style.display = 'block';
                        data.forEach(p => {
                            const div = document.createElement('div'); div.className = 'suggestion-item';
                            div.innerHTML = `<i class="fa-solid fa-location-dot"></i> ${p.display_name.substring(0,35)}...`;
                            div.onclick = () => { setLocation(type, {lat:p.lat, lng:p.lon}, p.display_name); list.style.display='none'; };
                            list.appendChild(div);
                        });
                    } else list.style.display = 'none';
                } catch(e){}
            }, 500);
        }
        function setLocation(type, latlng, text) {
            document.getElementById(type).value = text.split(',')[0];
            const iconUrl = type==='origin'?'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png':'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
            const icon = new L.Icon({iconUrl, shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
            if(type==='origin') { if(markerOrigin) map.removeLayer(markerOrigin); markerOrigin = L.marker(latlng, {icon}).addTo(map).bindPopup("Inicio").openPopup(); }
            else { if(markerDest) map.removeLayer(markerDest); markerDest = L.marker(latlng, {icon}).addTo(map).bindPopup("Fin").openPopup(); }
            map.setView(latlng, 14);
            if(markerOrigin && markerDest) {
                if(polyline) map.removeLayer(polyline);
                polyline = L.polyline([markerOrigin.getLatLng(), markerDest.getLatLng()], {color:'blue', dashArray:'5,10'}).addTo(map);
                map.fitBounds(new L.featureGroup([markerOrigin, markerDest]).getBounds().pad(0.2));
            }
        }
        function resetMap() {
            if(markerOrigin) map.removeLayer(markerOrigin); if(markerDest) map.removeLayer(markerDest); if(polyline) map.removeLayer(polyline);
            markerOrigin=null; markerDest=null; document.getElementById('origin').value=''; document.getElementById('dest').value='';
            map.setView([-12.0464, -77.0428], 12);
        }
        
        // --- VIAJES ---
        function showTab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
            if(btn) btn.classList.add('active');
            if(name==='request') setTimeout(()=>map.invalidateSize(), 100);
        }
        function startPolling() { loadTrips(); setInterval(loadTrips, 1000); }

        async function requestTrip() {
            const org = document.getElementById('origin').value; const dst = document.getElementById('dest').value; const amt = document.getElementById('amt').value;
            if(!org || !dst || !amt) return showToast('Completa los campos', 'error');
            const trip = { rider_id: currentUser._id, start_location: org, end_location: dst, status: 'requested', payment: {amount:parseFloat(amt), payment_method:document.getElementById('method').value}};
            await fetch('/api/trips', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(trip)});
            showToast('Solicitud enviada (60s)', 'success');
            resetMap(); document.getElementById('amt').value='';
            showTab('status', document.querySelectorAll('.nav-item')[1]); loadTrips();
        }
        async function cancelTrip(id, auto = false) {
            if(!auto && !confirm('¬øCancelar viaje?')) return;
            await fetch(`/api/trips/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:'cancelled'})});
            if(auto) showToast('‚åõ Tiempo agotado', 'error'); else showToast('Cancelado', 'info');
            loadTrips();
        }
        async function sendPriceUpdate(id, amount, method) {
            const newPrice = prompt("Nueva oferta (S/.):", amount);
            if(newPrice && parseFloat(newPrice) !== amount) {
                await fetch(`/api/trips/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ payment: { amount: parseFloat(newPrice), payment_method: method } }) });
                showToast(`Oferta: S/. ${newPrice} (Tiempo reiniciado)`, 'success'); loadTrips();
            }
        }

        // --- RENDERIZADO ---
        async function loadTrips() {
            const res = await fetch('/api/trips'); const trips = await res.json();
            const myTrips = trips.filter(t => t.rider_id && t.rider_id._id === currentUser._id);
            const active = myTrips.filter(t => t.status === 'requested' || t.status === 'ongoing');
            
            document.getElementById('active-list').innerHTML = active.map(t => {
                let timerHtml = '';
                if(t.status === 'requested') {
                    const baseTime = t.updatedAt ? new Date(t.updatedAt).getTime() : getTimestampFromId(t._id);
                    const now = Date.now(); const diff = Math.floor((now - baseTime) / 1000); const left = TIME_LIMIT - diff;
                    if(left <= 0) { cancelTrip(t._id, true); return ''; }
                    const pct = (left / TIME_LIMIT) * 100; const color = left < 10 ? '#ef4444' : '#f59e0b';
                    timerHtml = `<div class="timer-label"><span><i class="fa-solid fa-stopwatch"></i> Caduca en:</span> <span class="pulse-text" style="color:${color}; font-weight:bold;">${left}s</span></div><div class="timer-container"><div class="timer-bar" style="width:${pct}%; background:${color};"></div></div>`;
                }

                return `
                <div class="card" style="border-left-color:${t.status==='ongoing'?'#10b981':'#f59e0b'}">
                    <div class="card-header"><span class="badge">${t.status==='requested'?'üîç Buscando':'üöï En Camino'}</span><span class="price-tag">S/. ${t.payment.amount}</span></div>
                    ${timerHtml}
                    <div class="route-detail"><div><i class="fa-solid fa-circle-dot" style="color:var(--primary)"></i> ${t.start_location}</div><div><i class="fa-solid fa-location-dot" style="color:var(--danger)"></i> ${t.end_location}</div></div>
                    ${t.driver_id ? `<div style="background:#f0f9ff; padding:10px; border-radius:8px; margin-top:5px;"><i class="fa-solid fa-taxi"></i> <strong>${t.driver_id.name}</strong> ‚Ä¢ ${t.vehicle_id?.plate||'---'}</div>` : ''}
                    ${t.status === 'requested' ? `<div style="display:flex; gap:10px; margin-top:10px;"><button onclick="sendPriceUpdate('${t._id}', ${t.payment.amount}, '${t.payment.payment_method}')" style="font-size:0.85rem; padding:8px;"><i class="fa-solid fa-pencil"></i> Ofertar</button><button onclick="cancelTrip('${t._id}')" style="background:var(--danger); font-size:0.85rem; padding:8px;">Cancelar</button></div>` : ''}
                </div>
            `}).join('') || '<p class="text-center">Sin viajes activos</p>';

            const hist = myTrips.filter(t => t.status === 'completed' || t.status === 'cancelled');
            document.getElementById('history-list').innerHTML = hist.map(t => {
                const date = new Date(parseInt(t._id.substring(0, 8), 16) * 1000).toLocaleString();
                const isDone = t.status === 'completed';
                const payLabel = paymentLabels[t.payment.payment_method] || t.payment.payment_method;

                return `
                <div class="card" style="padding:12px; border-left: 4px solid ${isDone ? 'var(--secondary)' : 'var(--danger)'}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <small style="color:#888"><i class="fa-regular fa-calendar"></i> ${date}</small>
                        <span class="badge" style="background:${isDone?'#dcfce7':'#fee2e2'}; color:${isDone?'green':'red'}">${t.status === 'completed' ? 'Finalizado' : 'Cancelado'}</span>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <div style="font-weight:600; font-size:1rem;"><i class="fa-solid fa-flag-checkered" style="color:var(--danger)"></i> ${t.end_location}</div>
                        <small style="color:#555; display:block; margin-top:4px;"><i class="fa-solid fa-location-dot" style="color:var(--primary)"></i> Desde: ${t.start_location}</small>
                    </div>

                    ${t.driver_id ? `
                        <div style="background:#f8fafc; padding:8px; border-radius:6px; margin:8px 0; font-size:0.85rem; display:flex; gap:10px; align-items:center;">
                            <div style="font-size:1.5rem; color:#64748b;"><i class="fa-solid fa-car-side"></i></div>
                            <div>
                                <div style="font-weight:bold; color:#333;">${t.vehicle_id?.model || 'Auto'}</div>
                                <div style="font-size:0.85rem; color:#666;">Placa: <strong style="color:#000;">${t.vehicle_id?.plate || '---'}</strong> ‚Ä¢ ${t.driver_id.name}</div>
                            </div>
                        </div>
                    ` : '<div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">cancelado sin conductor</div>'}

                    <div style="border-top:1px dashed #eee; padding-top:8px; display:flex; justify-content:space-between; align-items:center;">
                        <small>${payLabel}</small>
                        <div style="font-size:1.1rem; font-weight:bold; color:var(--dark);">S/. ${t.payment.amount}</div>
                    </div>
                </div>
            `}).join('');
        }

        init();
    </script>
</body>
</html>
